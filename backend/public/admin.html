<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAN CRM Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: #2563eb;
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .auth-section {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .auth-section h2 {
            margin-bottom: 1rem;
            color: #2563eb;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 1rem;
        }

        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background: #1d4ed8;
        }

        .btn-danger {
            background: #dc2626;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .status {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 4px;
            font-weight: 500;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .dashboard {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h3 {
            margin-bottom: 1rem;
            color: #2563eb;
        }

        .data-list {
            margin-top: 1rem;
        }

        .data-item {
            padding: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-item:last-child {
            border-bottom: none;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .actions .btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
        }

        .close {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .tab {
            padding: 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab.active {
            border-bottom-color: #2563eb;
            color: #2563eb;
            font-weight: 500;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .logout-btn {
            position: absolute;
            top: 1rem;
            right: 2rem;
            background: #dc2626;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .logout-btn:hover {
            background: #b91c1c;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>RAN CRM Admin Panel</h1>
        <button class="logout-btn" onclick="logout()" style="display: none;">Logout</button>
    </div>

    <div class="container">
        <!-- Authentication Section -->
        <div id="auth-section" class="auth-section">
            <h2>Login</h2>
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" placeholder="admin">
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" placeholder="admin123">
            </div>
            <button class="btn" onclick="login()">Login</button>
            <div id="auth-status"></div>
            <div style="margin-top: 1rem; font-size: 0.875rem; color: #666;">
                <strong>Test Accounts:</strong><br>
                Admin: admin / admin123<br>
                User: user / user123
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="dashboard">
            <div class="tabs">
                <div class="tab active" onclick="showTab('users')">Users</div>
                <div class="tab" onclick="showTab('contacts')">Contacts</div>
                <div class="tab" onclick="showTab('calls')">Call Logs</div>
                <div class="tab" onclick="showTab('sync')">Sync Audit</div>
            </div>

            <!-- Users Tab -->
            <div id="users-tab" class="tab-content active">
                <div class="card">
                    <h3>Users Management</h3>
                    <div class="actions">
                        <button class="btn" onclick="showCreateUserModal()">Create User</button>
                        <button class="btn" onclick="loadUsers()">Refresh</button>
                    </div>
                    <div id="users-list" class="data-list"></div>
                </div>
            </div>

            <!-- Contacts Tab -->
            <div id="contacts-tab" class="tab-content">
                <div class="card">
                    <h3>Contacts</h3>
                    <div class="actions">
                        <button class="btn" onclick="showCreateContactModal()">Create Contact</button>
                        <button class="btn" onclick="loadContacts()">Refresh</button>
                    </div>
                    <div class="form-group">
                        <input type="text" id="contact-search" placeholder="Search contacts..." onkeyup="searchContacts()">
                    </div>
                    <div id="contacts-list" class="data-list"></div>
                </div>
            </div>

            <!-- Call Logs Tab -->
            <div id="calls-tab" class="tab-content">
                <div class="card">
                    <h3>Call Logs</h3>
                    <div class="actions">
                        <button class="btn" onclick="loadCalls()">Refresh</button>
                        <button class="btn btn-danger" onclick="clearAllCallLogs()" id="clear-calls-btn" style="display: none;">Clear All Call Logs</button>
                    </div>
                    <div id="calls-list" class="data-list"></div>
                </div>
            </div>

            <!-- Sync Audit Tab -->
            <div id="sync-tab" class="tab-content">
                <div class="card">
                    <h3>Sync Audit</h3>
                    <div class="actions">
                        <button class="btn" onclick="loadSyncAudit()">Refresh</button>
                    </div>
                    <div id="sync-list" class="data-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="create-user-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('create-user-modal')">&times;</span>
            <h3>Create User</h3>
            <div class="form-group">
                <label for="user-username">Username:</label>
                <input type="text" id="user-username">
            </div>
            <div class="form-group">
                <label for="user-name">Name:</label>
                <input type="text" id="user-name">
            </div>
            <div class="form-group">
                <label for="user-password">Password:</label>
                <input type="password" id="user-password">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="user-admin"> Admin
                </label>
            </div>
            <button class="btn" onclick="createUser()">Create</button>
        </div>
    </div>

    <!-- Create Contact Modal -->
    <div id="create-contact-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('create-contact-modal')">&times;</span>
            <h3>Create Contact</h3>
            <div class="form-group">
                <label for="contact-name">Name:</label>
                <input type="text" id="contact-name">
            </div>
            <div class="form-group">
                <label for="contact-phone">Phone:</label>
                <input type="text" id="contact-phone" placeholder="+1 (555) 123-4567">
            </div>
            <button class="btn" onclick="createContact()">Create</button>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('token');

        // Initialize
        if (token) {
            showDashboard();
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    showDashboard();
                    showStatus('Login successful!', 'success');
                } else {
                    showStatus(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                showStatus('Network error', 'error');
            }
        }

        function logout() {
            token = null;
            localStorage.removeItem('token');
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('auth-section').style.display = 'block';
            document.querySelector('.logout-btn').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('dashboard').style.display = 'grid';
            document.querySelector('.logout-btn').style.display = 'block';
            loadUsers();
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('auth-status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            setTimeout(() => {
                statusEl.textContent = '';
                statusEl.className = 'status';
            }, 5000);
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Show selected tab
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Load data for the tab
            switch(tabName) {
                case 'users':
                    loadUsers();
                    break;
                case 'contacts':
                    loadContacts();
                    break;
                case 'calls':
                    loadCalls();
                    break;
                case 'sync':
                    loadSyncAudit();
                    break;
            }
        }

        async function apiRequest(endpoint, options = {}) {
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
            };

            const response = await fetch(endpoint, { ...defaultOptions, ...options });
            return response;
        }

        async function loadUsers() {
            try {
                const response = await apiRequest('/users');
                const data = await response.json();

                if (response.ok) {
                    displayUsers(data.data);
                } else {
                    console.error('Failed to load users');
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function displayUsers(users) {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';

            users.forEach(user => {
                const userEl = document.createElement('div');
                userEl.className = 'data-item';
                userEl.innerHTML = `
                    <div>
                        <strong>${user.username}</strong> - ${user.name}
                        ${user.is_admin ? '<span style="color: #dc2626;">Admin</span>' : ''}
                    </div>
                    <button class="btn btn-danger" onclick="deleteUser('${user.id}')">Delete</button>
                `;
                usersList.appendChild(userEl);
            });
        }

        async function loadContacts() {
            try {
                const response = await apiRequest('/contacts');
                const data = await response.json();

                if (response.ok) {
                    displayContacts(data.data);
                }
            } catch (error) {
                console.error('Error loading contacts:', error);
            }
        }

        function displayContacts(contacts) {
            const contactsList = document.getElementById('contacts-list');
            contactsList.innerHTML = '';

            contacts.forEach(contact => {
                const contactEl = document.createElement('div');
                contactEl.className = 'data-item';
                contactEl.innerHTML = `
                    <div>
                        <strong>${contact.name}</strong><br>
                        <small>${contact.phone_raw}</small>
                    </div>
                    <button class="btn btn-danger" onclick="deleteContact('${contact.id}')">Delete</button>
                `;
                contactsList.appendChild(contactEl);
            });
        }

        async function loadCalls() {
            try {
                const response = await apiRequest('/calls');
                const data = await response.json();

                if (response.ok) {
                    displayCalls(data.data);
                }
            } catch (error) {
                console.error('Error loading calls:', error);
            }
        }

        function displayCalls(calls) {
            const callsList = document.getElementById('calls-list');
            callsList.innerHTML = '';

            // Show clear button for admins if there are calls
            const clearBtn = document.getElementById('clear-calls-btn');
            if (calls.length > 0 && clearBtn) {
                clearBtn.style.display = 'inline-block';
            }

            calls.forEach(call => {
                const callEl = document.createElement('div');
                callEl.className = 'data-item';
                const timestamp = new Date(call.timestamp).toLocaleString();
                const duration = `${Math.floor(call.duration_seconds / 60)}:${(call.duration_seconds % 60).toString().padStart(2, '0')}`;
                
                callEl.innerHTML = `
                    <div>
                        <strong>${call.contact_name || call.contact_phone || 'Unknown'}</strong> <span style="color: #6b7280; font-size: 0.875rem;">(${call.username || 'Unknown User'})</span><br>
                        <small>${call.direction} - ${duration} - ${timestamp}</small>
                    </div>
                `;
                callsList.appendChild(callEl);
            });
            
            if (calls.length === 0) {
                callsList.innerHTML = '<p style="padding: 1rem; text-align: center; color: #6b7280;">No call logs found</p>';
            }
        }

        async function loadSyncAudit() {
            try {
                const response = await apiRequest('/sync-audit');
                const data = await response.json();

                if (response.ok) {
                    displaySyncAudit(data.sync_audits || []);
                }
            } catch (error) {
                console.error('Error loading sync audit:', error);
            }
        }

        function displaySyncAudit(syncs) {
            const syncList = document.getElementById('sync-list');
            syncList.innerHTML = '';

            if (syncs.length === 0) {
                syncList.innerHTML = '<p style="padding: 1rem; text-align: center; color: #6b7280;">No sync audit data found</p>';
                return;
            }

            syncs.forEach(sync => {
                const syncEl = document.createElement('div');
                syncEl.className = 'data-item';
                syncEl.style.display = 'block';
                syncEl.style.padding = '1rem';
                
                const contactsStatus = sync.contacts_status || 'N/A';
                const callsStatus = sync.calls_status || 'N/A';
                const contactsTime = sync.contacts_last_sync ? new Date(sync.contacts_last_sync).toLocaleString() : 'Never';
                const callsTime = sync.calls_last_sync ? new Date(sync.calls_last_sync).toLocaleString() : 'Never';
                
                const contactsStatusStyle = contactsStatus === 'success' ? 'color: #059669;' : contactsStatus === 'error' ? 'color: #dc2626;' : 'color: #6b7280;';
                const callsStatusStyle = callsStatus === 'success' ? 'color: #059669;' : callsStatus === 'error' ? 'color: #dc2626;' : 'color: #6b7280;';
                
                syncEl.innerHTML = `
                    <div style="margin-bottom: 0.5rem;">
                        <strong style="font-size: 1rem;">${sync.username}</strong> <span style="color: #6b7280; font-size: 0.875rem;">(${sync.user_name})</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;">
                        <div>
                            <strong>Contacts:</strong><br>
                            <span style="${contactsStatusStyle}">●</span> ${contactsStatus.toUpperCase()}<br>
                            <span style="color: #6b7280;">Last Sync: ${contactsTime}</span><br>
                            <span style="color: #6b7280;">Count: ${sync.synced_contacts || 0}</span>
                            ${sync.contacts_error ? `<br><span style="color: #dc2626; font-size: 0.75rem;">${sync.contacts_error}</span>` : ''}
                        </div>
                        <div>
                            <strong>Call Logs:</strong><br>
                            <span style="${callsStatusStyle}">●</span> ${callsStatus.toUpperCase()}<br>
                            <span style="color: #6b7280;">Last Sync: ${callsTime}</span><br>
                            <span style="color: #6b7280;">Count: ${sync.synced_calls || 0}</span>
                            ${sync.calls_error ? `<br><span style="color: #dc2626; font-size: 0.75rem;">${sync.calls_error}</span>` : ''}
                        </div>
                    </div>
                `;
                syncList.appendChild(syncEl);
            });
        }

        function showCreateUserModal() {
            document.getElementById('create-user-modal').style.display = 'block';
        }

        function showCreateContactModal() {
            document.getElementById('create-contact-modal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        async function createUser() {
            const username = document.getElementById('user-username').value;
            const name = document.getElementById('user-name').value;
            const password = document.getElementById('user-password').value;
            const isAdmin = document.getElementById('user-admin').checked;

            try {
                const response = await apiRequest('/users', {
                    method: 'POST',
                    body: JSON.stringify({ username, name, password, is_admin: isAdmin }),
                });

                if (response.ok) {
                    closeModal('create-user-modal');
                    loadUsers();
                    // Clear form
                    document.getElementById('user-username').value = '';
                    document.getElementById('user-name').value = '';
                    document.getElementById('user-password').value = '';
                    document.getElementById('user-admin').checked = false;
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to create user');
                }
            } catch (error) {
                console.error('Error creating user:', error);
            }
        }

        async function createContact() {
            const name = document.getElementById('contact-name').value;
            const phone = document.getElementById('contact-phone').value;

            // Simple phone normalization for demo
            const phoneNormalized = phone.replace(/\D/g, '');

            try {
                const response = await apiRequest('/contacts', {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        phone_raw: phone,
                        phone_normalized: phoneNormalized,
                        created_at: new Date().toISOString()
                    }),
                });

                if (response.ok) {
                    closeModal('create-contact-modal');
                    loadContacts();
                    // Clear form
                    document.getElementById('contact-name').value = '';
                    document.getElementById('contact-phone').value = '';
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to create contact');
                }
            } catch (error) {
                console.error('Error creating contact:', error);
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;

            try {
                const response = await apiRequest(`/users/${userId}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    loadUsers();
                } else {
                    alert('Failed to delete user');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
            }
        }

        async function deleteContact(contactId) {
            if (!confirm('Are you sure you want to delete this contact?')) return;

            try {
                const response = await apiRequest(`/contacts/${contactId}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    loadContacts();
                } else {
                    alert('Failed to delete contact');
                }
            } catch (error) {
                console.error('Error deleting contact:', error);
            }
        }

        function searchContacts() {
            const query = document.getElementById('contact-search').value;
            if (query.length < 2) {
                loadContacts();
                return;
            }

            // Debounce search
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(async () => {
                try {
                    const response = await apiRequest(`/contacts/search?q=${encodeURIComponent(query)}`);
                    const data = await response.json();

                    if (response.ok) {
                        displayContacts(data.data);
                    }
                } catch (error) {
                    console.error('Error searching contacts:', error);
                }
            }, 300);
        }

        async function clearAllCallLogs() {
            if (!confirm('Are you sure you want to clear ALL call logs? This action cannot be undone.')) return;

            try {
                const response = await apiRequest('/calls', {
                    method: 'DELETE',
                });

                if (response.ok) {
                    alert('All call logs cleared successfully');
                    loadCalls();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to clear call logs');
                }
            } catch (error) {
                console.error('Error clearing call logs:', error);
                alert('Error clearing call logs');
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
